{
  "hash": "d1b4312ae19b7284916f5c9d27db404b",
  "result": {
    "markdown": "---\ntitle: \"Evidence Synthesysis for Decision Making in Healthcare\"\nauthor: \"Joseph Rickert and Robert Horton\"\ndate: 2025-03-12\ndescription: \"This post presents a JAGS version of a WinBUGS model presented in the classic textbook *Evidence Synthesis for Decision Making in Healthcare* by Nicky J. Welton, Alexander J. Sutton, Nicola J. Cooper, Keith R, Abrams, and A.E. Ades.\"\nfig-dpi: 300\nfig-align: \"center\"\nimage: esdsh.jpg\ncode-fold: TRUE\ncode-summary: \"Show the code\"\neditor: source\n---\n\n\nThis post is based on the textbook: [*Evidence Synthesis for Decision Making in Healthcare*](https://onlinelibrary.wiley.com/doi/book/10.1002/9781119942986) (ESDMH) by Nicky J. Welton, Alexander J. Sutton, Nicola J. Cooper, Keith R, Abrams, and A.E. Ades. This textbook is an exemplary presentation of health care decision analysis and Bayesian modeling. The only impediment to its aging well and enjoying a long shelf life that we perceive is that all of code was done in [`WinBugs`](https://en.wikipedia.org/wiki/WinBUGS), pioneering but now obsolete software for evaluating Bayesian MCMC models. Below, we present a `JAGS` version of the `WinBugs` model in Example 2.1 on page 26 of the text. We hope that this post will be useful to readers who would like to work through the examples in the text using tools that are easily accessible.\n\n## The JAGS Workflow\n\nWe will follow the workflow for building JAGS models as is presented in the [Introduction to jagsUI vignette](https://cran.r-project.org/web/packages/jagsUI/vignettes/jagsUI.html) a JAGS workflow comprises the following steps:\n\n1.  Organize data into a named list\n2.  Write model file in the BUGS language\n3.  Specify initial MCMC values (optional)\n4.  Specify which parameters to save posteriors for analysis\n5.  Specify MCMC settings\n6.  Run JAGS\n7.  Examine output\n\n## The Blockers Model\n\nWe will run random effects model presented i Example 2.1 using the `jagsUI` and `rjags` packages that accept code using the `WinBUGS` modeling language and calls the`JAGS` Bayesian engine to evaluate the model. The packages required are loaded here.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary('rjags')\nlibrary('coda')\nlibrary('jagshelper')\nlibrary('jagsUI')\nlibrary('mcmcplots')  # caterplot\nlibrary('dplyr')\nlibrary('readxl')\nlibrary('jagsUI') # calls rjags\n```\n:::\n\n\n## The Data\n\nThe data comprises empirical log odds ratios, $Y_j$: $$ Y_j = \\log\\left(\\dfrac{\\delta_j}{1 - \\delta_j}\\right)$$\n\nalong with their associated sample variances, $V_j$ for twenty-two randomized clinical trials where patients who suffered a myocardial infarction were treated either with beta-blockers or a placebo. The Excel file containing the data along with the original `WinBUGS` code is available [here](https://bcs.wiley.com/he-bcs/Books?action=resource&bcsId=7268&itemId=047006109X&resourceId=28154).\n\nHere we read the data from a local Excel file. Note that the Blocker Excel file is among the supporting materials that can be downloaded from the [Wiley site](https://bcs.wiley.com/he-bcs/Books?action=resource&bcsId=7268&itemId=047006109X&resourceId=28154).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nBLOCKER <- read_excel(\"BLOCKER.xls\") |>\n            mutate(trial = 1: length(Y))\n\nhead(BLOCKER,3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 Ã— 3\n        Y     V trial\n    <dbl> <dbl> <int>\n1  0.0282 0.723     1\n2 -0.741  0.233     2\n3 -0.541  0.319     3\n```\n:::\n:::\n\n\n## The JAGS Model\n\nNext, we organize the data which must be structured as a list for JAGS.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- BLOCKER |> select(-trial) |>\n      as.list()  \ndata['Nstud'] <- nrow(BLOCKER)\n```\n:::\n\n\n### Specify the JAGS Model.\n\nThe following code specifies random effects JAGS model. The study specific log odds ratios, $\\delta_j$, are assumed to be samples from a common random distribution: $\\delta_j \\sim N(d.\\tau^2)$ where d is is the population mean of log odds ratios and $\\tau^2$ is the between-studies variance. We assume a flat uniform prior distribution for $tau$\n\nSee the [JAGS manual](https://sourceforge.net/projects/mcmc-jags/files/Manuals/4.x/) for details.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Model\n\nmodel_code <- \"model {\n  # Likelihood\n  for (j in 1:Nstud) {\n    P[j] <- 1/V[j]      # Calculate precision\n    Y[j] ~ dnorm(delta[j],P[j])\n    delta[j] ~ dnorm(d,prec)\n  }\n  \n  # Priors\n  d ~ dnorm(0,1.0E-6)\n  prec <- 1/tau.sq\n  tau.sq <- tau*tau   # between-study variance\n  tau ~ dunif(0,10)   # Uniform on SD\n}\" %>% textConnection\n\n# Note that model_code is a string and the textConnection function is used \n# to pass this string to the jags() function further down in the code.\n```\n:::\n\n\nThis code initializes the parameter values. Note that we use a function to specify reasonable distributions from which multiple MCMC chains will be initialized.\n\n\n::: {.cell Warning='false' Message='false'}\n\n```{.r .cell-code}\n# Note that the WinBugs code in the book initializes the MCMC algorithm with a single chain as follows.\n#initial_values <- list(list(\n# delta=c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),d=0,tau=1))\n\n# We use this code  which initializes the MCMC algorithm with three chains \n# whose values are drawn from probability distributions.\nset.seed(9999)\ninits  <- function(){  \n  list(delta=rnorm(22,0,0.5),\n       d=rnorm(1,0,1),\n       tau=runif(1,0,3)\n  )  \n}\n```\n:::\n\n\nThis next block of code specifies the MCMC model. The key parameters are:\n\n- n.chains: The umber of MCMC chains to run\n- n.adapt: Number of iterations to run in the `JAGS` adaptive phase.  See [Andrieu & Thoms (2008)](https://projecteuclid.org/euclid.bj/1208874824) for a discussion of adaptive MCMC\n- n.iter : Number of iterations per chain including burn-in\n- n.burnin : Number of iterations to discard as burn-in\n- n.thin : The thinning rate: every kth sample will be discarded to reduce autocorrelation. See [Link & Eaton (2012)](https://digitalcommons.unl.edu/cgi/viewcontent.cgi?article=2194&context=usgsstaffpub) for a discussion of thinning.\n \n \n\n\n::: {.cell Warning='false' Message='false'}\n\n:::\n\n\n### Examine the output\n\n\n\nThe posterior distributions for the model parameters are the main results of the model. `jags` samples these distributions and computes the posterior mean, standard error, credible intervals, and diagnostic statistics for the parameters d, $tau$, four of the $\\delta_j$ parameters, and the deviance. The values shown here are very close to those reported in the text. (Note, for purposes of presentation we display only four values of the $delta_j$ parameters.)\n\n\n::: {.cell}\n\n```{.r .cell-code}\noptions(width = 999)\nres <- out_initial\nh_res <- head(res$summary,4)\nt_res <- tail(res$summary,4)\nsignif(rbind(h_res,t_res),3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n            mean     sd     2.5%     25%    50%    75%   97.5% Rhat n.eff overlap0     f\nd         -0.247 0.0660 -0.37200 -0.2900 -0.248 -0.203 -0.1130 1.00  1000        0 1.000\ntau        0.132 0.0811  0.00849  0.0674  0.125  0.184  0.3080 1.01   405        0 1.000\ndelta[1]  -0.239 0.1660 -0.57600 -0.3270 -0.244 -0.156  0.1220 1.00  3930        1 0.930\ndelta[2]  -0.288 0.1580 -0.64600 -0.3670 -0.277 -0.196  0.0112 1.00 15000        1 0.971\ndelta[20] -0.240 0.1300 -0.50100 -0.3200 -0.243 -0.167  0.0403 1.00 10800        1 0.959\ndelta[21] -0.325 0.1410 -0.65300 -0.4020 -0.309 -0.231 -0.0831 1.00 11900        0 0.994\ndelta[22] -0.319 0.1430 -0.65000 -0.3930 -0.302 -0.225 -0.0779 1.00 15000        0 0.993\ndeviance   7.810 4.5800 -1.22000  4.5100  8.050 11.300 16.0000 1.00  1950        1 0.952\n```\n:::\n:::\n\n\n\n### Diagnostic Statistics\nThe diagnostic statistics are interpreted as follows:\n\n-   `Rhat`, [the Gelman-Rubin Statistic](https://journals.sagepub.com/doi/abs/10.1177/096228029600500402), is a diagnostic compares the variance within chains to the variance between chains. Values close to 1 (typically less than 1.1) indicate that the chains have converged.\n-   `n.eff`: provides an estimate of how many independent samples the samples in the chain are equivalent to. A higher number suggests more reliable estimates.\n-   `overlap0` = 0 indicates that the 95% credible interval does not include 0, suggesting a statistically significant effect.\n-   `f` is the proportion of the posterior with the same sign as the mean.\n\nAdditionally, the `jags`function returns two alternative penalized deviance statistics, The deviance information criterion, DIC, and the penalized expected deviance, pD, which are generated via the `dic.samples()` function. Both of these statistics penalize model complexity: smaller is better. For this model DIC = 18.3016 and pD = 10.4929\n\nAs calculated by `jags()`, DIC is an approximation to the penalized deviance used when only point estimators are available, i.e.,  $D(\\theta) = -2\\log(L(\\theta))$ where $L(\\theta)$ is the likelihood of the model given the data . The approximation holds asymptotically when the effective number of parameters is much smaller than the sample size, and the when the posterior distributions of the model parameters are normally distributed. See page 6 of the [`rjags` pdf](https://cran.r-project.org/web/packages/rjags/rjags.pdf) for details and*Bayesian measures of model complexity and fit*, by [Spiegelhalter et al. (2002)](https://rss.onlinelibrary.wiley.com/doi/abs/10.1111/1467-9868.00353) for the theory.\n\nFor background on pD see *Penalized loss functions for Bayesian model comparison*, [Plummer (2008)](https://academic.oup.com/biostatistics/article-abstract/9/3/523/224568?redirectedFrom=fulltext) The penalized expected deviance (Plummer 2008) is \n\nNote\nthat all of the output we have been discussing can be generated at once just by printing the model output function as shown here.\n\n\n\n\n\n#### Density Plots\n\nThe density plots show the posterior distribution of the estimated parameters: the posterior distribution of the population mean, $d$, the between-study variance, $\\tau^2$, the study-specific log odds ratios, $\\delta_j$, and the deviance. We only show the first density plot here, but the sharp peak is representative of all of the $\\delta_j$ plots. (Note that an easy modification of the code will plot them all.)\n\n\n::: {.cell}\n\n```{.r .cell-code}\njagsUI::densityplot(out_initial, parameters = c(\"d\", \"tau\", \"deviance\",\"delta[1]\"), layout=c(2,2))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=2100}\n:::\n:::\n\n\n#### Whisker Plot\n\nThe following plot shows the posterior mean for and 95% credible interval for the population mean, $d$, and the study specific log odds ratios, $\\delta_j$.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolnames <- c(\"d\", sprintf(\"delta[%d]\", 1:22))\ncaterplot(out_initial$samples[, colnames]) \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=2100}\n:::\n:::\n\n\n### MCMC Diagnostics\n\nA key MCMC diagnostic reported by the `jags() function` of the jagsUI package is sufficient.adapt, a logical value indicating whether the number of iterations for adaptation was sufficient. For this model:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"Sufficient Adaptation =\", out_initial$mcmc.info$sufficient.adapt, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSufficient Adaptation = TRUE \n```\n:::\n:::\n\n \n\n#### Trace Plots\n\nThe trace plots show the evolution of the three Markov Chains (each in a different color) for all of the estimated variables. The chains appear to be mixing well. However, it is noteworthy that some of the blue chain seems to get stuck for a while as is indicated by the short flat segments. The plot of the $\\delta_1$ parameter is representative of the behavior of the other delta parameters. You can check this yourself by just using \"delta\" in the plot command below to plot all of the $\\delta_j$ parameters.\n\nIn addition to the model parameters, the `traceplot()` function also displays the MCMC trace for the deviance, a statistical measure that indicates how well the model fits the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\njagsUI::traceplot(out_initial, parameters = c(\"d\",\"tau\", \"deviance\", \"delta[1]\"), layout=c(2,2))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=2100}\n:::\n:::\n\n\n\n## Some Closing Remarks\n\nWe think that the point of view taken in ESDMH that Bayesian models which integrate statistical estimations of clinical outcomes with economic considerations is an elegant and powerful approach to decision making in healthcare. This post is just a first step towards showing how ESDMH develops this process. In posts to come we hope to present more examples from the text.\n\n\n*Bob Horton started his career as a molecular biologist, studying genes involved in immune responses (MHC evolution and TCR repertoire), and developing genetic engineering techniques. Analyzing and simulating biological data led him into data science and his current interests which include semantic searching of text data and decision modeling.*\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
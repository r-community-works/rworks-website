{
  "hash": "0f20a4d3606974095dcef20f39b064c5",
  "result": {
    "markdown": "---\ntitle: \"Cost-Effectiveness Analysis\"\nauthor: \"Robert Horton Joseph Rickert\"\ndate: 2025-04-07\ndescription: \"\"\nimage: \"\"\nimage-alt: \"\"\ncategories: \"\"\ncode-fold: true\ncode-summary: \"Show the code\"\neditor: source\nformat:\n  html:\n    toc: true # Enables the table of contents\n    toc-depth: 3 # (Optional) Sets the depth of headers to include (e.g., h1, h2, h3)\n    toc-location: left # (Optional) Places the table of contents on the left\n---\n\n\nIn a previous post, we presented an `rjags` version of a Bayesian model from Chapter 2 of the textbook: *Evidence Synthesis for Decision making in Healthcare* by [Welton et al. (2012)](https://bcs.wiley.com/he-bcs/Books?action=index&bcsId=7268&itemId=047006109X). In this post, we continue our project to present `rjags` versions of the `WinBugs` models in the text by presenting the economic decision models from Chapter 3. note that to run the code below you must first install the `JAGS` program which is available from <http://mcmc-jags.sourceforge.net/>, and the `rjags` package is available from <https://cran.r-project.org/web/packages/rjags/index.html>.\n\n\nChapter 3 of the text explores the health economics decision of whether or not a healthcare system should adopt the practice of prophylactically administering an antibiotic to women who are about to give birth by Cesarean section. Two versions of a decision model are presented: a deterministic model and a stochastic model. The deterministic model lays out the decision framework and calculates the expected costs of the two options: administering the antibiotic or not. The stochastic model adds uncertainty to the decision framework by assigning probability distributions to the parameters in the deterministic model. The stochastic model is then used to conduct a cost-effectiveness analysis of the two options.\n\nNot that cost effectiveness decision frameworks in healthcare are  typically presented as a Cost-Utility analysis, conducted from a systems perspective that measures utility of medical effects in Quality Adjusted Life Years using ICERs *(Incremental Cost Effectiveness Ratio) = (Additional Costs) / (Additional Benefits)*.\n\nThe final decision often comes down to examining the equation: Net Benefit = Uλ - C where:\n\n-   U = Lifetime utility of intervention (usually measured in [QALYS](https://en.wikipedia.org/wiki/Quality-adjusted_life_year))\n-   λ = money value attributed to a unit of health gain: i.e. the exchange rate\n-   C = lifetime cost\n\n\nThe following figure depicts the decision as a tree. The decision of whether or not to prescribe prophylactic antibiotics is represented by the square node labelled 'Px\". The two branches from this node represent the treatment and control groups. These groups are represented as circles because they are \"chance nodes\"; people in those groups may or may not go on to get a wound infection. The probability of infection is different for each group (p1 and p2). The four leaves of the tree are the four possible outcomes: getting a wound infection or not in either the treatment or the control. We can compute a cost for each outcome. For example, the most expensive outcome is for patients who received the antibiotic and got an infection anyway, because they have both the costs of providing the prophylaxis and the costs of treating the wound. Though not shown on the diagram, we can also compute a utility (in QALYs) for each outcome (e.g., time a patient spends in the hospital is not as valuable as time spent otherwise). The expected cost and utility of each main branch are a probability-weighted average of the costs and utilities of the leaves of that branch.\n\n![](decision_tree.png){fig-alt=\"The decision tree.\"}\n\n\n\n\n# Deterministic Decision Analysis\n\nIn this section we will present a deterministic model of the problem that can be described by means of the following directed graph. Variables in blue on the right side if the diagram represent cost data (see the table in the section \"Resource Use and Cost Data\" below). The costs of the four leaves of our decision tree are computed from these values. A patient with an infected wound will have a different cost per day of care that a patient without a woud infection, and presumably a diferent length of stay in the hospital. In addition, the treatment group has costs associated with buying and administering multiple doses of the prophylactic antibiotic.\n\nThe variables `nc1` and `rc1` are the total number of Caesarean sections and wound infections in the health system making the decision. Since they do not yet use prophylactic antibiotics for thie operation, these values let us estimate the prevalence of wound infections in the untreated group (`p1`).\n\nThe green variables in the upper left (a through d) represent data from a clinical trial (see the table in the \"Clinical Data\" section below). Since the prevalence of wound infection in the hospitals where the study was done is different from that in the target health system, we need to compute the relative risk for treated vs. control patients in the study. This is just the proportion of patients getting an infection in the treatment group, divided by the proportion in the control group:\n\n\n\n# THIS NEW PARAGRAPH IS REDUNDANT\n\nThis diagram is a Directed Acyclic Graph (DAG) that shows how the variables in the program depend on one another. Variables in green (a, b, c, and d) come from the clinical effectiveness study [the table in the section titled \"The Clinical DATA\"]; these are the numbers of infected and non-infected surgical wounds in the treated and untreated cohorts, respectively. These numbers are used to estimate the relative risk for a treated vs. untreated patient. We need to use relative risk because the absolute risk may be very different at different institutions (in this caseV the efficacy study was conducted in Africa, while the target institution is in the UK). Variables in blue are from the economic study done at the target institution; they include costs of administering the antibiotic, estimates of length of stay for women with and without an infected wound, and the expected prevalence of these wound infections in the target institution. The overall costs for the treatment branch and the control branch are computed as the probability-weighted average of the costs of the outcomes, as described by the decision tree.\n\n\n\n![](deterministic.png){fig-alt=\"Deterministic DAG.\"}\n\n$$ Relative Risk = \\frac{a/(a+b)}{c/(c+d)}$$\nwhere:\n\n-   a is the number of women who received antibiotics and subsequently developed infections\n-   b is the number of women who received antibiotics who did not develop infections\n-   c is the number of women who received the placebo and subsequently became infected\n-   d is the number of women who received the placebo who did not become infected\n\n\nThe deterministic model presented in this section may be found on page 56 in section 3.4 of the text.\n\n## The Clinical Data\n\nThe data for the effectiveness of prophylactic antibiotics to reduce infection in women delivering by cesarean section comes from a study by [Bibi et al., (1994)](https://pubmed.ncbi.nlm.nih.gov/8051377/). \n\nThis code executes the model by simply computing the products and sums, and displays the results. There is nothing Bayesian or stochastic here yet; this model just does some simple math in JAGS to lay the foundation for subsequent refinements.\n\n## Preparations for running the model.\n\nThis section of code loads the necessary libraries and contains a couple of helper functions that are used later in the code. The first function, `coda_sample_2_df`, extracts data from a coda sample into a dataframe. The second function, `plot_densities_from_coda_df`, makes comparative density plots for the given variables.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# libraries\nlibrary(coda, verbose=FALSE)\nlibrary(rjags, verbose = FALSE)      # coda.samples\nlibrary(jagsUI, verbose=FALSE)     # wrapper for rjags\nlibrary(mcmcplots)  # caterplot\nlibrary(tidyverse, verbose=FALSE)\nlibrary(gridExtra)\n\n# A couple of helper functions\n#| message: FALSE\n#| warning: FALSE\n#| echo: FALSE\n# functions\ncoda_sample_2_df <- function(my_coda_sample){\n  # Extract data from a coda sample into a dataframe\n  seq_along(my_coda_sample) %>% lapply(function(chain){\n    df <- my_coda_sample[[chain]] %>% as.matrix %>% as.data.frame\n    df['chain'] <- chain\n    df\n  }) %>% \n    bind_rows %>% \n    mutate(chain=factor(chain))\n}\n\nplot_densities_from_coda_df <- function(vars, coda_df){\n  # Make comparative density plots for the given variables\n  coda_df %>% \n    select(all_of(vars)) %>%\n    pivot_longer(cols=vars) %>% \n    ggplot(aes(x=value, col=name, fill=name)) + geom_density(alpha=0.6)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\neffectiveness_df <- data.frame( \nDescription = c(\"Prophylactic antibiotics\", \"Placebo\"),\n  Infection = c(4, 28),\n  No_infection = c(129, 108),\n  row.names = c(\"Treatment\", \"Control\")\n) %>% mutate(Total = Infection + No_infection)\n\neffectiveness_df\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                       Description Infection No_infection Total\nTreatment Prophylactic antibiotics         4          129   133\nControl                    Placebo        28          108   136\n```\n:::\n:::\n\n\n## Resource Use and Cost Data\n\nThe resource use and cost data comes from able 3.3, p55. Data is from [Mugford et al., 1989](https://pubmed.ncbi.nlm.nih.gov/2511938/), except for the cost of administering antibiotic which was estimated by Welton et al.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncost_df <- data.frame(\n  Parameter = c( \"Length of stay: infection\",\n                 \"Length of stay: no infection\",\n                 \"Cost per day: infection\",\n                 \"Cost per day: no infection\",\n                 \"Cost per dose: cephaslosporin\",\n                 \"Cost per administering antibiotic\",\n                 \"Doses administered\",\n                 \"Total number of Caesarians\",\n                 \"Number infections: no antibiotics\"\n              ),\n  Estimate = c(8.80, 6.70, 163.03, 107.26, 5.67, 7.00, 3, 486, 41),\n  Units=c(\"days\", \"days\", \"£\", \"£\", \"£\", \"£\", \"count\", \"count\", \"count\"),\n  Variable_name=c(\"loswd\", \"losnwd\", \"cstwd\", \"cstnwd\", \"cstPx\", \"cstadmin\", \"dose\", \"nc1\", \"rc1\")\n)\n\ncost_df\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                          Parameter Estimate Units Variable_name\n1         Length of stay: infection     8.80  days         loswd\n2      Length of stay: no infection     6.70  days        losnwd\n3           Cost per day: infection   163.03     £         cstwd\n4        Cost per day: no infection   107.26     £        cstnwd\n5     Cost per dose: cephaslosporin     5.67     £         cstPx\n6 Cost per administering antibiotic     7.00     £      cstadmin\n7                Doses administered     3.00 count          dose\n8        Total number of Caesarians   486.00 count           nc1\n9 Number infections: no antibiotics    41.00 count           rc1\n```\n:::\n:::\n\n\nThe following code builds a model in the `BUGS` language for specifying probability distributions that will be evaluated by the `rjags` interface to the `JAGS` MCMC engine.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_code <- \"\nmodel {\n  cost_nwdpx <- losnwd * cstnwd + dose * (cstPx + cstadmin) # Cost (No infection/Px)\n  cost_wdpx <- loswd * cstwd + dose * (cstPx + cstadmin)    # Cost (Infection/Px)\n  cost_nwd <- losnwd * cstnwd                               # Cost (No infection/no Px)\n  cost_wd <- loswd * cstwd                                  # Cost (Infection/no Px)\n  \n  RR <- (a/(a+b))/(c/(c+d))                                 # Relative risk using \n                                                            # data from table 3.2\n                                                            \n  p1 <- rc1/nc1\n  p2 <- RR * p1\n  \n  costtrt <- ((1-p2) * cost_nwdpx) + p2 * cost_wdpx         # Total cost (payoff) Px\n  costctl <- ((1-p1) * cost_nwd) + p1 * cost_wd             # Total cost (payoff) No Px\n\n}\"\n\ncost_data <- with(cost_df, setNames(as.list(Estimate), nm=Variable_name))\neffectiveness_data <-  list(\n  a=effectiveness_df['Treatment', 'Infection'],\n  b=effectiveness_df['Treatment', 'No_infection'],\n  c=effectiveness_df['Control', 'Infection'],\n  d=effectiveness_df['Control', 'No_infection']\n)\ndeterministic_data <- append(cost_data, effectiveness_data)\n\n# deterministic_data <- list(\n#   losnwd=6.7,\n#   loswd=8.8,\n#   cstnwd=107.26,\n#   cstwd=163.03,\n#   cstPx=5.67,  # !!! `cstdrug` should be `cstPx`\n#   cstadmin=7,\n#   dose=3,\n#   rc1=41,\n#   nc1=486, \n#   a=4,\n#   b=129,\n#   c=28,\n#   d=108\n# )\n```\n:::\n\n\nThis code executes the model and displays the results. Notice that the expected costs of the treatment and control branches match those in the text on p56.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresults <- jags(\n  data = deterministic_data,\n  parameters.to.save = c(\"p1\", \"p2\", \"costtrt\", \"costctl\"),\n  model.file = model_code %>% textConnection,\n  n.chains = 1,\n  n.iter=1,\n  verbose = FALSE\n)\n\n#| message: FALSE\n#| warning: FALSE\nresults \n```\n\n::: {.cell-output .cell-output-stdout}\n```\nJAGS output for model '5', generated by jagsUI.\nEstimates based on 1 chains of 1 iterations,\nadaptation = 100 iterations (sufficient),\nburn-in = 0 iterations and thin rate = 1,\nyielding 1 total samples from the joint posterior. \nMCMC ran for 0.001 minutes at time 2025-05-10 13:27:04.390041.\n\n           mean sd    2.5%     50%   97.5% overlap0 f\np1        0.084 NA   0.084   0.084   0.084    FALSE 1\np2        0.012 NA   0.012   0.012   0.012    FALSE 1\ncosttrt 765.476 NA 765.476 765.476 765.476    FALSE 1\ncostctl 779.047 NA 779.047 779.047 779.047    FALSE 1\n\noverlap0 checks if 0 falls in the parameter's 95% credible interval.\nf is the proportion of the posterior with the same sign as the mean;\ni.e., our confidence that the parameter is positive or negative.\n```\n:::\n:::\n\n\n# Stochastic Decision Analysis\n\nHaving established a deterministic baseline model, the next step is to account for the uncertainty in the modeling assumptions by developing a Bayesian stochastic model that uses probability distributions rather than point estimates to represent uncertain parameters. \n\nThis diagram shows the relationships between variables in the stochastic model. The red nodes are stochastic variables, as is the orange outcome node (differential cost). These depend on parameterized random distributions. For example, the relative risk (RR) and prevalence of infection in the target hospital (p1) are no longer simple point estimates as they were in the deterministic model; instead they are modeled by statistical distributions parameterized by the observed data (see equations below). The probabilty of infection in the treatment group (p2) is also stochastic, since it is computed by adjusting p1 for the relative risk.\n\n\nThe cost of administering the drug is now randomly taken from a range, the length of stay estimates are described as Normal distributions with a given mean and precision, the prevalence of infection in the target health system is represented with a beta distribution parameterized using the same numbers as before, and the relative risk is modeled by a Normal distribution on the log scale. Variables computed from these stochastic variables are stochastic as well, so 'p2', 'cst.trt', and 'cst.ctl' are also red, and the outcome of all this 'diff.cost' is in turn estimated stochastically.\n\n![](stochastic.png){fig-alt=\"Stochastic Model DAG.\"}\n\n# Model with Distributions\n\nThe next step towards working our way up to a full Bayesian model is to assign probability distributions to the clinical variables for which there is uncertainty. These are:\n\n## Distribution of ln(Relative Risk):\n\n$$ ln(RR)\\sim N(\\theta, prec)$$ $$ \\theta = log\\left(\\frac{a/(a+b)}{c/(c+d)}\\right) $$ $$ prec = \\frac{1}{(1/a) - 1 / (a + b)  + (1/c) - 1(/(c + d)} \\\\$$\n\nwhere as above:\n\n-   a is the number of women who received antibiotics and subsequently developed infections\n-   b is the number of women who received antibiotics who did not develop infections\n-   c is the number of women who received the placebo and subsequently became infected\n-   d is the number of women who received the placebo who did not become infected\n\n## Distribution of Prob\\[infection \\| no antibiotic\\]\n\n$$ p_1 \\sim Beta( \\alpha, \\beta)$$\n\nwhere:\n\n-   $\\alpha = rc1$\n-   $\\beta = nc1 - rc1$\n-   rc1 = Number infections: no antibiotics\n-   nc1 = Total number of Carnelians\n\n$p_2 = e^{lnRR} p_1$\n\nis the distribution for the probability of an infection with the antibiotic.\n\n$loswd \\sim N(mnloswd, precwd)$\n\nis the distribution of the length of a hospital stay with infection where:\n\n$precwd = \\frac{1}{(sdloswd/\\sqrt{numwd})^2}$\n\n$losnwd \\sim N(mnlosnwd, precnwd)$\n\nis the distribution for length of hospital stay without infection, where:\n\n$precnwd = \\frac{1}{(sdlosnwd/\\sqrt{numwd})^2}$\n\n$cstadmin \\sim U(4, 10)$ is the distribution of the antibiotic dose administered.\n\n$cst.trt = (1-p_2)((cstPx + cstadmin)3 + (losnwd)(cstnwd)) + p_2((cstPx + cstadmin)3 + (loswd)(cstwd))$\n\nis the total cost for the \"payoff\" of the antibiotic arm of the decision tree.\n\n$cst.ctl = (1-p_1)(losnwd)(cstnwd) + p_1(loswd)(cstwd)$\n\nis the total cost for the payoff of the no antibiotic arm of the decision tree.\n\n$diff.cost = cst.trt - cst.ctl$ is the differential cost.\n\n## Code for the Stochastic Model\n\nThis next block of `BUGS` code implements the stochastic model described above. The code is similar to the deterministic model, but with the addition of the distributions for the parameters that are uncertain. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nstochastic_model_code <- \"\nmodel{\n  lnRR ~ dnorm(theta, prec)   # Distribution for ln(Relative Risk)\n  theta <- log( (a/(a+b)) / (c/(c+d)) )\n  prec <- 1/( (1/a) - (1/(a+b)) + (1/c) - (1/(c+d)) )\n  \n  p1 ~ dbeta(alpha, beta) # Distribution for Prob(Infection/NoPx)\n  alpha <- rc1\n  beta <- nc1 - rc1\n  \n  p2 <- exp(lnRR) * p1  # Distribution for Prob(Infection/Px)\n  \n  loswd ~ dnorm(mnloswd, precwd)  # Distribution for length of stay with infection\n  precwd <- 1/pow(sdloswd/sqrt(numwd), 2)\n  \n  losnwd ~ dnorm(mnlosnwd, precnwd)  # Distribution for length of stay w/o infection\n  precnwd <- 1/pow(sdlosnwd/sqrt(numnwd), 2)\n  \n  cstadmin ~ dunif(4, 10) # Px administration\n  \n  cst.trt <- (1-p2)*((cstPx + cstadmin)*3 + (losnwd*cstnwd)) + p2*((cstPx + cstadmin)*3 + (loswd*cstwd)) # Total cost (payoff) Px\n  \n  cst.ctl <- (1-p1)*(losnwd*cstnwd) + p1*(loswd*cstwd) # Total cost (payoff) No Rx\n  \n  diff.cost <- cst.trt - cst.ctl  # Difference in cost\n}\" %>% textConnection()\n```\n:::\n\n\n## Data for the Stochastic Model\n\nThis block of R code provides parameter values for the stochastic model. The values are taken from the text, but some of them have been changed to reflect the fact that we are now using a stochastic model. The changes are indicated in the comments.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstochastic_data <- list(\n  rc1=41, nc1=486, cstwd=163.03, cstnwd=107.26,\n  mnloswd=8.8, sdloswd=3.5,\n  mnlosnwd=6.7, sdlosnwd=7.1,\n  numwd=41, numnwd=445, # !!! numwd == rc1; numnwd == (nc1 - rc1)\n  cstPx=5.67,\n  # rt=4, nt=133, rc=28, nc=136,  # !!! Unused variables\n  a=4, b=129, c=28, d=108\n)\n\n# Here I code the changes from the data for the deterministic model to the \n# data for the stochastic one, in case that makes the differences easier to see.\n\n    # Add these:\n    # setdiff(names(stochastic_data), names(deterministic_data))\n    # \"mnloswd\"  \"sdloswd\"  \"mnlosnwd\" \"sdlosnwd\"\n    # \"numwd\" ==  rc1;\n    # \"numnwd\" == (nc1 - rc1)\n    # \n    # Remove or rename these:\n    # setdiff(names(deterministic_data), names(stochastic_data))\n    #  \"loswd\" -> \"mnloswd\"\n    #  \"losnwd\" -> \"mnlosnwd\"\n    #  \"cstadmin\" hard-coded uniform distribution\n    #  \"dose\": hard-coded !!!\n\n# uncertainty <- c(sdloswd=3.5, sdlosnwd=7.1) # standard deviations from Table 3.4\n# rename_me <- c(\"loswd\"=\"mnloswd\", \"losnwd\"=\"mnlosnwd\")\n# \n# stochastic_data <- append(deterministic_data, uncertainty)\n# for (old_name in names(rename_me)){\n#   new_name <- rename_me[[old_name]]\n#   names(stochastic_data)[names(stochastic_data) == old_name] <- new_name\n# }\n# stochastic_data[\"cstadmin\"] <- NULL # now coded as uniform random\n# stochastic_data[\"dose\"] <- NULL # the 3 is hard coded now\n# \n# stochastic_data[\"numwd\"] <- stochastic_data[\"rc1\"]; \n# stochastic_data[\"numnwd\"] <-  with(stochastic_data, (nc1 - rc1))\n\n\nparameters_to_save <- c(\"cst.trt\", \"cst.ctl\", \"diff.cost\")\n```\n:::\n\n\n## Code to Run the Stochastic Model\n\nThis code runs the stochastic model. The code is similar to the deterministic model, but with the addition of the distributions for the parameters that are uncertain.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstochastic_results <- jags( data = stochastic_data,\n                            parameters.to.save = parameters_to_save,\n                            model.file = stochastic_model_code,\n                            n.chains = 4,\n                            n.adapt = 100,\n                            n.iter = 50000,\n                            n.burnin = 20000,\n                            verbose = FALSE)\n```\n:::\n\n\n## Model Results\n\nThe following table shows a summary of the model results. These include the mean, standard deviations, and quantiles for the posterior distributions of the cost of treatment and control, the differential cost and the relative risk, along with information on some diagnostic statistics. The results are similar to those in the text on p 66.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstochastic_results_summary <- summary(stochastic_results) |> as.data.frame() |> select(!c(3,4))\n\nround(stochastic_results_summary,3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n             mean     sd     50%     75%   97.5% Rhat  n.eff overlap0     f\ncst.trt   766.768 36.518 766.775 791.394 838.524    1 115913        0 1.000\ncst.ctl   779.138 35.119 779.110 802.959 847.856    1 120000        0 1.000\ndiff.cost -12.370 12.729 -11.812  -3.653  11.154    1 120000        1 0.837\n```\n:::\n:::\n\n\nThe diagnostic statistics are interpreted as follows:\n\n-   Rhat, the Gelman-Rubin Statistic, is a diagnostic that compares the variance within chains to the variance between chains. Values close to 1 (typically less than 1.1) indicate that the chains have converged.\n-   n.eff: provides an estimate of how many independent samples the samples in the chain are equivalent to. A higher number suggests more reliable estimates.\n-   overlap0 = 0 indicates that the 95% credible interval does not include 0, suggesting a statistically significant effect.\n-   f is the proportion of the posterior with the same sign as the mean.\n\n## Diagnostic Plots\n\nIn this section we will plot the results of the MCMC sampling. The first plot shows the trace plots for the three parameters of interest. The second plot shows the density plots for the same three parameters. Multiple colors on each of the trace plots indicates that the four independent MCMC chains are on top of each other and mixing well. We can see that the chains have converged to a common distribution.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(stochastic_results)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n## Prior Distributions\n\nIn this section we plot the Prior distribution that were described above.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Prior Distribution for log Relative Risk\na <- stochastic_data$a\nb <- stochastic_data$b\nc <- stochastic_data$c\nd <- stochastic_data$d\ntheta <- log( (a/(a+b)) / (c/(c+d)) )\n#theta\nprec <- 1/( (1/a) - (1/(a+b)) + (1/c) - (1/(c+d)) )\n#prec\nvar = 1/prec\n#var\n# Generate a sequence of x values\nx <- seq(-15, 15, length.out = 100)\n\n# Compute the corresponding beta density values\nlnRR <- dnorm(x, theta, prec)\n\n# Create a data frame for ggplot2\nnorm_data <- data.frame(x = x, y = lnRR)\n\n# Plot the beta distribution\nq1 <- ggplot(norm_data, aes(x = x, y = lnRR)) +\n  geom_line(color = \"brown\", linewidth = 1) + \n  geom_area( fill = \"brown\", alpha = 0.2) + \n  labs(title = \"Prior: Log Relative Risk\",\n       x = \"Lpg(RR)\",\n       y = \"Density\")\n\n\n### Prior Distribution for p1\n# Define the beta distribution parameters\nalpha <- stochastic_data$rc1\nbeta <- stochastic_data$nc1 - stochastic_data$rc1\n\n# Generate a sequence of x values\nx <- seq(0, .2, length.out = 100)\n\n# Compute the corresponding beta density values\ny <- dbeta(x, alpha, beta)\n\n# Create a data frame for ggplot2\nbeta_data <- data.frame(x = x, y = y)\n\n# Plot the beta distribution\nq2 <- ggplot(beta_data, aes(x = x, y = y)) +\n  geom_line(color = \"blue\", linewidth = 1) +\n  geom_area( fill = \"blue\", alpha = 0.2) + \n  labs(title = \"Prior: Infection | no antibiotic\",\n       x = \"p1\",\n       y = \"Density\")\n\n\n### Prior distribution for length of stay, wound infection\n# Define the normal distribution parameters\nmean <- stochastic_data$mnloswd\nsd <- stochastic_data$sdlosnwd/sqrt(stochastic_data$numwd)\n\n# Generate a sequence of x values\nx <- seq(5, 15, length.out = 100)\n\n# Compute the corresponding beta density values\ny <- dnorm(x, mean, sd)\n\n# Create a data frame for ggplot2\nnorm_data <- data.frame(x = x, y = y)\n\n# Plot the beta distribution\nq3 <- ggplot(norm_data, aes(x = x, y = y)) +\n  geom_line(color = \"red\", linewidth = 1) +\n   geom_area( fill = \"red\", alpha = 0.2) +\n   xlim(5,13) +\n  labs(title = \"Prior: length of stay | infection\",\n       x = \"Length of Stay (days) \",\n       y = \"Density\")\n\n\n## Prior distribution for length of stay, no wound infection\n# Define the normal distribution parameters\nmean <- stochastic_data$mnlosnwd\nsd <- stochastic_data$sdlosnwd/sqrt(stochastic_data$numnwd)\n\n# Generate a sequence of x values\nx <- seq(5, 10, length.out = 100)\n\n# Compute the corresponding beta density values\ny <- dnorm(x, mean, sd)\n\n# Create a data frame for ggplot2\nnorm_data <- data.frame(x = x, y = y)\n\n# Plot the beta distribution\nq4 <- ggplot(norm_data, aes(x = x, y = y)) +\n  geom_line(color = \"darkgreen\", linewidth = 1) +\n   geom_area( fill = \"green\", alpha = 0.2) +\n   xlim(5, 13) + \n  labs(title = \"Prior: length of stay | no infection\",\n       x = \"Length of Stay (days)\",\n       y = \"Density\")\n\ngrid.arrange(q1, q3, q2, q4) \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n## Posterior Distributions\n\nHere we re-sample an existing model and plot densities of several variables using the R functions defined at the beginning of this document.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_vars <- c('p1', 'p2', 'cst.trt', 'cst.ctl', 'diff.cost')\ncoda_df <- coda.samples(stochastic_results$model, variable.names = my_vars, \n    n.iter = 10000) %>% \n  coda_sample_2_df %>% \n  sample_frac(1L) # randomly scramble chain order\n```\n:::\n\n\nPlot the posterior densities for the cost of treatment\n\n\n::: {.cell}\n\n```{.r .cell-code}\nw1 <- plot_densities_from_coda_df(c('cst.trt', 'cst.ctl'), coda_df) + ggtitle(\"Posterior Densities for Cost of Treatment\")\nw1\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\nPlot the posterior density for Differential Cost\n\n\n::: {.cell}\n\n```{.r .cell-code}\nw2 <- coda_df %>% ggplot(aes(x=diff.cost)) + geom_density(fill = \"blue\", alpha = 0.5) + ggtitle(\"Posterior Density for Differential Cost\")\nw2\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\nPlot the densities for P1 and P2\n\n\n::: {.cell}\n\n```{.r .cell-code}\nw3 <- plot_densities_from_coda_df(c('p1', 'p2'), coda_df) + ggtitle(\"Posterior Densities for P1 and P2\")\nw3\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n# The Stochastic Economic Model\n\nThis next section of code integrates the computations forcost-effectiveness into the model model presented above. You can find this code on page 65 of the text.\n\n\n::: {.cell}\n\n```{.r .cell-code}\neconomic_model_code <- \"\nmodel{\n  lnRR ~ dnorm(theta, prec) # Distribution for ln(Relative Risk)\n  theta <- log( (a/(a+b)) / (c/(c+d)) )\n  prec <- 1/( (1/a) - (1/(a+b)) + (1/c) - (1/(c+d)) )\n  \n  p1 ~ dbeta(alpha, beta)  # Distribution for Prob(Infection/NoPx)\n  alpha <- rc1\n  beta <- nc1 - rc1\n  \n  p2 <- exp(lnRR) * p1   # Distribution for Prob(Infection/Px)\n  \n  loswd ~ dnorm(mnloswd, precwd)   # Distribution for length of stay with infection\n  precwd <- 1/pow(sdloswd/sqrt(numwd), 2)\n  \n  losnwd ~ dnorm(mnlosnwd, precnwd) # Distribution for length of stay w/o infection\n  precnwd <- 1/pow(sdlosnwd/sqrt(numnwd), 2)\n  \n  cstadmin ~ dunif(4, 10)   # Px administration\n  \n  cst.trt <- (1-p2)*((cstPx + cstadmin)*3 + (losnwd*cstnwd)) + p2*((cstPx + cstadmin)*3 + (loswd*cstwd)) # Total cost (payoff) Px\n  \n  cst.ctl <- (1-p1)*(losnwd*cstnwd) + p1*(loswd*cstwd) # Total cost (payoff) No Rx\n  \n  diff.cost <- cst.trt - cst.ctl   # Difference in cost\n\n  \n  # Economic evaluation code from pp 65-66\n  \n  totQALYs.wd <- ((QALYwd/365)*loswd) + ((Fullhealth/365)*(fllwupdays-loswd)) # QALYs (infection)\n  totQALYs.nwd <- ((QALYnwd/365)*losnwd) + ((Fullhealth/365)*(fllwupdays-losnwd)) # QALYs (No infection)\n\n  QALYs.trt <- (1-p2) * totQALYs.nwd + p2 * totQALYs.wd  # QALYs (Px)\n  QALYs.ctl <- (1-p1) * totQALYs.nwd + p1 * totQALYs.wd  # QALYs (no px)\n  diff.QALYs <- (QALYs.trt - QALYs.ctl)                  # Difference in QALYs\n  \n  for (k in 1:M)\n  {\n  \tlambda[k] <- (k-1) * 2000\n  \tINB[k] <- lambda[k] * diff.QALYs - diff.cost  # !!! not `delta.Qalys` or `delta.cost`\n  \tProbCE[k] <- step(INB[k])\n  }\n}\n\" %>% textConnection()\n\n# economic_data <- list(\n#   rc1=41, nc1=486, cstwd=163.03, cstnwd=107.26,\n#   mnloswd=8.8, sdloswd=3.5,\n#   mnlosnwd=6.7, sdlosnwd=7.1,\n#   numwd=41, numnwd=445,\n#   cstPx=5.67,\n#   a=4, b=129, c=28, d=108,\n#   # additional data for economic evaluation\n#   M=21, QALYwd=0.68, QALYnwd=0.88, Fullhealth=1, fllwupdays=20\n# )\n\neconomic_data <- append(stochastic_data,\n  # additional data for economic evaluation\n  list(M=21, QALYwd=0.68, QALYnwd=0.88, Fullhealth=1, fllwupdays=20)\n)\n\nparameters_to_save <- c(#\"ProbCE\", \n  \"cst.trt\", \"cst.ctl\", \"diff.cost\", \"p1\", \"p2\")\n```\n:::\n\n\n## Run the Economic Model\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\neconomic_results <- jags(data = economic_data,\n            parameters.to.save = parameters_to_save,\n            model.file = economic_model_code,\n            n.chains = 1,\n            n.adapt = 100,\n            n.iter = 50000,\n            n.burnin = 20000,\n            verbose=FALSE)\n```\n:::\n\n\nAnd now, the economic results\n\n\n::: {.cell}\n\n```{.r .cell-code}\neconomic_results_summary <- summary(economic_results) %>% as.data.frame()\n\nround(economic_results_summary,3) |> select(!c(3,4))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n             mean     sd     50%     75%   97.5% Rhat n.eff overlap0     f\ncst.trt   766.868 36.171 766.733 791.292 838.161   NA     1        0 1.000\ncst.ctl   779.242 34.876 779.169 802.913 847.709   NA     1        0 1.000\ndiff.cost -12.373 12.777 -11.757  -3.638  11.146   NA     1        1 0.837\np1          0.085  0.013   0.084   0.093   0.111   NA     1        0 1.000\np2          0.014  0.008   0.012   0.018   0.035   NA     1        0 1.000\n```\n:::\n:::\n\n\n## The Economic Decision\n\n### Cost-Effectiveness\n\nThe effectiveness of a healthcare intervention is often expressed *QALYS*, Quality-Adjusted Life Year which combine mortality and morbidity from treatment outcomes into a single value. By putting diverse medical outcomes on the same scale, it makes it possible to allocate funds among very different programs (cancer care, prenatal care, vaccine programs, etc.). \n\nThe following figure which plots the results of many simulations of the economic model on the cost-effectiveness plane is the major tool for facilitating the decision as to whether to adopt the practice of prophylactically administering antibiotics. The x-axis represents the incremental QALYs and the y-axis represents the incremental costs. The dashed lines represent different values for $\\lambda$ the cut-off cost. The solid line represents the line of no difference in cost or QALYs.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Figure 3.4: Cost-effectiveness plane (10000 simulations) for Caesarean section example.\nce_vars <- c(\"diff.QALYs\", \"diff.cost\")\nce_df <- coda.samples(economic_results$model, variable.names = ce_vars, \n    n.iter = 10000) %>% coda_sample_2_df\n  \nXLIM = c(0, 7e-4)     # use same limits as chapter 3\nYLIM = c(-75, 50)\nLAMBDAS = 10000*(1:3)\nCE_1 <-ce_df %>%\n  ggplot(aes(x=diff.QALYs, y=diff.cost, col=chain)) + \n  geom_point(size=0.5, alpha=0.1) +\n  geom_abline(slope=0, intercept=0, linetype='solid') +\n  geom_abline(slope=LAMBDAS, intercept=0, linetype='dotted') +\n  theme(legend.position=\"none\") +\n  labs(x = \"Incremental QALYs\", y = \"Incremental costs\", title=\"Cost-effectiveness plane for Caesarian section example\") + \n  coord_cartesian(xlim=XLIM, ylim=YLIM) + \n  annotate(\"text\", x = XLIM[2], y = LAMBDAS * XLIM[2], \n           size=3, hjust=0.8, vjust=-0.25,\n           label = paste(\"lambda ==\", LAMBDAS), parse=TRUE)\nCE_1\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\n Life Year (QALY) combines mortality and morbidity from treatment outcomes into a single value. By putting diverse medical outcomes on the same scale, it makes it possible to allocate funds among very different programs (cancer care, prenatal care, vaccine programs, etc.). Note that, although this metric is widely used for budgeting decisions regarding healthcare technologies, it is not generally suitable for all applications. For example, QALYs are not always helpful for making decisions faced by individual patients [Ioannidis 2011].\n\n\nThis next figure shows the expected incremental net benefit and 95% credible interval for a range of lambda values. The x-axis represents the value of lambda and the y-axis represents the expected incremental net benefit. The dashed lines represent the 2.5% and 97.5% quantiles of the posterior distribution of the incremental net benefit.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninb_vars <- c(\"INB\", \"ProbCE\")\ninb_df <- coda.samples(economic_results$model, variable.names = inb_vars, \n    n.iter = 10000) %>% \n  coda_sample_2_df %>%\n  group_by(chain) %>%\n  mutate(iteration=row_number()) %>%\n  ungroup() %>%\n  as.data.frame\n\ninb_df_long <- inb_df %>% \n  pivot_longer(\n    cols=1:42,\n    names_to=c(\"metric\", \"k\"),\n    names_pattern=\"(INB|ProbCE)\\\\[(\\\\d+)\\\\]\",\n    values_to=\"value\"\n  ) %>%\n  mutate(k=as.integer(k), lambda=2000*(k-1))\n\n\ninb_df_long %>%\n  group_by(metric, lambda) %>%\n  filter(metric==\"INB\") %>%\n  summarize(\n    mean_INB=mean(value),\n    lo_end=quantile(value, probs=0.025),\n    hi_end=quantile(value, probs=0.975)) %>% \n  ggplot(aes(x=lambda, group=metric)) + \n    geom_line(aes(y=mean_INB)) + \n    geom_line(aes(y=lo_end), linetype=\"dashed\") + \n    geom_line(aes(y=hi_end), linetype=\"dashed\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n\n\n# Closing Remarks\n\nChapter 3 from Welton et al. presents an analysis of a classic healthcare technology assessment decision informed by a Bayesian statistical analysis and a decision structure that includes economic analysis and utility measured in QALYs. The decision is from the point of view of a public health system concerned with providing the best outcome for a population given their budgetary constraints. However, the framework and the methodology can easily be reframed for decisions to be made by other organizations and individuals.\n\nA truly elegant feature of this model is that the uncertainties in the model parameters supporting the clinical calculations are expressed as probability distributions which propagate through the decision tree to compute the expected costs and benefits of each alternative. This integrated treatment of uncertainty that is superior to models that are limited to using point estimates to drive the economic decisions.\n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}